#!/bin/bash

REDIS='redis-cli --raw -h su-redis'

SCRIPT_NAME=$(basename $0)

CLOUD_PECENT=100
#ORBITA_PONTO_BR='001-57 001-58 001-59 001-60 001-61 001-62 001-63 001-64 001-65 001-66 001-67 001-68 002-57 002-58 002-59 002-60 002-61 002-62 002-63 002-64 002-65 002-66 002-67 002-68 003-57 003-58 003-59 003-60 003-61 003-62 003-63 003-64 003-65 003-66 003-67 003-68 004-58 004-59 004-60 004-61 004-62 004-63 004-64 004-65 004-66 004-67 004-68 005-59 005-60 005-61 005-62 005-63 005-64 005-65 005-66 005-67 006-63 006-64 006-65 006-66 213-64 213-65 213-66 213-67 214-63 214-64 214-65 214-66 214-67 214-68 214-70 214-71 214-72 215-63 215-64 215-65 215-66 215-67 215-68 215-69 215-70 215-71 215-72 215-73 215-74 215-75 215-76 216-62 216-63 216-64 216-65 216-66 216-67 216-68 216-69 216-70 216-71 216-72 216-73 216-74 216-74 216-75 216-75 216-76 216-77 217-61 217-62 217-63 217-64 217-65 217-66 217-67 217-68 217-69 217-70 217-71 217-72 217-73 217-74 217-75 217-76 217-77 218-61 218-62 218-63 218-64 218-65 218-66 218-67 218-68 218-69 218-70 218-71 218-72 218-73 218-74 218-75 218-76 218-77 218-78 219-61 219-62 219-63 219-64 219-65 219-66 219-67 219-68 219-69 219-70 219-71 219-72 219-73 219-74 219-75 219-76 219-77 219-78 219-79 219-80 219-81 220-61 220-62 220-63 220-64 220-65 220-66 220-67 220-68 220-69 220-70 220-71 220-72 220-73 220-74 220-75 220-76 220-77 220-78 220-79 220-80 220-81 220-82 221-60 221-61 221-62 221-63 221-64 221-65 221-66 221-67 221-68 221-69 221-70 221-71 221-72 221-73 221-74 221-75 221-76 221-77 221-78 221-79 221-80 221-81 221-82 221-83 221-84 222-60 222-61 222-62 222-63 222-64 222-65 222-66 222-67 222-68 222-69 222-70 222-71 222-72 222-73 222-74 222-75 222-76 222-77 222-78 222-79 222-80 222-81 222-82 222-83 222-84 223-60 223-61 223-62 223-63 223-64 223-65 223-66 223-67 223-68 223-69 223-70 223-71 223-72 223-73 223-74 223-75 223-76 223-77 223-78 223-79 223-80 223-81 223-82 223-83 224-58 224-59 224-60 224-61 224-62 224-63 224-64 224-65 224-66 224-67 224-68 224-69 224-70 224-71 224-72 224-73 224-74 224-75 224-76 224-77 224-78 224-79 224-80 224-81 224-82 225-57 225-58 225-59 225-60 225-61 225-62 225-63 225-64 225-65 225-66 225-67 225-68 225-69 225-70 225-71 225-72 225-73 225-74 225-75 225-76 225-77 225-78 225-79 225-80 225-81 225-82 226-57 226-58 226-59 226-60 226-61 226-62 226-63 226-64 226-65 226-66 226-67 226-68 226-69 226-70 226-71 226-72 226-73 226-74 226-75 226-76 226-77 226-80 226-81 227-57 227-58 227-59 227-60 227-61 227-62 227-63 227-64 227-65 227-66 227-67 227-68 227-69 227-70 227-71 227-72 227-73 227-74 227-75 227-76 228-58 228-59 228-60 228-61 228-62 228-63 228-64 228-65 228-66 228-67 228-68 228-69 228-70 228-71 228-72 228-73 229-58 229-59 229-60 229-61 229-62 229-63 229-64 229-65 229-66 229-67 229-68 229-69 229-70 229-71 229-72 230-57 230-58 230-59 230-60 230-61 230-62 230-63 230-64 230-65 230-66 230-67 230-68 230-69 230-70 230-71 230-72 231-56 231-57 231-58 231-59 231-60 231-61 231-62 231-63 231-64 231-65 231-66 231-67 231-68 231-69 231-70 232-56 232-57 232-58 232-59 232-60 232-61 232-62 232-63 232-64 232-65 232-66 232-67 232-68 232-69 233-56 233-57 233-58 233-59 233-60 233-61 233-62 233-63 233-64 233-65 233-66 233-67 233-68 233-69'
#ORBITA_PONTO_BR='001-65 001-66 001-67 002-65 002-66 002-67 003-65 003-66 003-67 003-68 221-61 221-62 221-63 221-64 221-65 221-66 222-61 222-62 222-63 222-64 222-65 222-66 222-67 222-68 223-61 223-62 223-63 223-64 223-65 223-66 223-67 223-68 223-69 224-62 224-63 224-64 224-65 224-66 224-67 224-68 224-69 225-62 225-63 225-64 225-65 225-66 225-67 225-68 225-69 226-62 226-63 226-64 226-65 226-66 226-67 226-68 226-69 226-70 227-63 227-64 227-65 227-66 227-67 227-68 227-69 227-70 228-64 228-65 228-66 228-67 228-68 228-69 229-64 229-65 229-66 229-67 229-68 229-69 230-63 230-64 230-65 230-66 230-67 230-68 231-63 231-64 231-65 231-66 231-67 231-68 232-64 232-65 232-66 232-67 232-68 233-64 233-65 233-66 233-67'
ORBITA_PONTO_CERRADO='220-71 219-71 218-71 217-71 221-71 219-62 219-63 223-64 222-64 219-64 223-65 222-65 221-65 220-65 219-65 223-66 222-66 221-66 220-66 219-66 224-67 223-67 222-67 221-67 220-67 219-67 218-67 229-68 228-68 227-68 224-68 223-68 222-68 221-68 220-68 219-68 218-68 229-69 228-69 227-69 226-69 225-69 224-69 223-69 222-69 221-69 220-69 219-69 218-69 229-70 228-70 227-70 226-70 225-70 224-70 223-70 222-70 221-70 220-70 219-70 218-70 227-71 226-71 225-71 224-71 223-71 222-71 225-72 224-72 223-72 222-72 221-72 220-72 219-72 218-72 217-72 225-73 224-73 223-73 222-73 221-73 220-73 219-73 218-73 226-74 225-74 224-74 223-74 222-74 221-74 220-74 219-74 218-74 226-75 225-75 224-75 223-75 222-75 221-75 220-75 219-75 225-76 222-76 221-76 220-76 219-76 221-77 220-77 220-62 220-63 220-64 221-62 221-63 221-64'
ORBITA_PONTO=$ORBITA_PONTO_CERRADO

NUMBER_DAYS=30
LANDSAT_DIR='/data/lapig/GEO/LANDSAT/siad'
ZIP_DIR=$LANDSAT_DIR/zip

SCRIPT_START_DATE='2013-04-01'

DATE_FORMAT='%Y-%m-%d'

#LC8 222 071 2014 156 LGN00

function get_params() {
	
	while getopts $SCRIPT_OPTS opt; do
		if [ $opt = '?' ]; then 
			echo "Invalid option -$OPTARG"
			exit
		else
			eval "$opt=$OPTARG" &> /dev/null
		fi
	done

}

SCRIPT_OPTS=":d:"
get_params $@

if [ "$d" = '' ]; then
	REDIS_KEY="$SCRIPT_NAME"
	#$REDIS DEL $REDIS_KEY # Delete Key

	if [ "$($REDIS EXISTS $REDIS_KEY)" = '1' ]; then
		SCRIPT_START_DATE=$($REDIS GET $REDIS_KEY)
	fi

	NEXT_MONTH_DATE=$(date -d "$SCRIPT_START_DATE+$NUMBER_DAYS days" +$DATE_FORMAT)
	SCRIPT_END_DATE=$(date -d "$NEXT_MONTH_DATE-1 day" +$DATE_FORMAT)
	$REDIS SET $REDIS_KEY $NEXT_MONTH_DATE &> /dev/null
else
	SCRIPT_START_DATE="$d"
	SCRIPT_END_DATE=$(date -d "$(date -d "$SCRIPT_START_DATE+$NUMBER_DAYS days" +$DATE_FORMAT)-1 day" +$DATE_FORMAT)
fi


SCRIPT_DIR=$LANDSAT_DIR/$(date -d "$SCRIPT_START_DATE" +'%Y-%m')

mkdir -p $SCRIPT_DIR
cd $SCRIPT_DIR

for orbitaPonto in $ORBITA_PONTO; do
	orbita=$(echo $orbitaPonto | cut -d'-' -f1)
	ponto=$(echo $orbitaPonto | cut -d'-' -f2)
	
	params="--start $SCRIPT_START_DATE --end $SCRIPT_END_DATE --cloud $CLOUD_PECENT -p $orbita,$ponto"
	
	searchParams="search $params" 
	sceneIDs=$(landsat $searchParams | grep 'sceneID' | cut -d\" -f4)
	
	downloadParams="download $sceneIDs -d $ZIP_DIR"

	landsat $downloadParams

	for sceneID in $sceneIDs; do

		mv -v $ZIP_DIR/$sceneID.tar.bz $SCRIPT_DIR
		tar xvf $SCRIPT_DIR/$sceneID.tar.bz
		rm -v $SCRIPT_DIR/$sceneID.tar.bz

	done

done

#for mtlFile in $(find -name '*_MTL.txt'); do
#	mosaikFile=$(echo $mtlFile | cut -f1 -d'_')
#	arcsi.py -s ls8 -f HFA --stats -p TOA -o . --outbasename $(echo $mtlFile | cut -f1 -d'_') -i $mtlFile
#done

#mkdir -p mosaik tiles
#
	#year=$(find -name '*_toa.img' | cut -b12-15 | sort | head -n1)
	#dt1=$(find -name '*_toa.img' | cut -b16-18 | sort | head -n1)
	#dt2=$(($dt1 + 16))
#
	#gdalMerge='gdal_merge.py -n 0 -co TFW=YES -co TILED=yes -co COMPRESS=DEFLATE -co BIGTIFF=YES'
#
	#find -name '*_toa.img' | grep $(seq -s'\|' $dt1 $(($dt1 + 15))) | xargs $gdalMerge -o mosaik/LC8$year$dt1.tif
	#find -name '*_toa.img' | grep $(seq -s'\|' $dt2 $(($dt2 + 15))) | xargs $gdalMerge -o mosaik/LC8$year$dt2.tif
#
	#mv -v *.TIF tiles
	#rm -v *.img

if [ "$d" = '' ] && [ $(date -d $SCRIPT_END_DATE +'%y%m%d') -le $(date +'%y%m%d')  ]; then
	nohup lapig-download-landsat.sh $@ >& /dev/null &
fi